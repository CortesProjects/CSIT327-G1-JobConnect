{% extends "dashboard/employer/employer_dashboard_base.html" %}
{% load static %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/dashboard/employer/employer_settings.css' %}">
{% endblock %}

{% block dashboard_content %}
{% if messages %}
<div class="messages-container">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">
        {{ message }}
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="settings-container">
    <h1 class="page-title">Settings</h1>

    <!-- Tabs Navigation -->
    <div class="settings-tabs">
        <button class="tab-btn active" data-tab="company-info">
            <i class="fas fa-building"></i>
            Company Info
        </button>
        <button class="tab-btn" data-tab="founding-info">
            <i class="fas fa-globe"></i>
            Founding Info
        </button>
        <button class="tab-btn" data-tab="account-setting">
            <i class="fas fa-cog"></i>
            Account Setting
        </button>
    </div>

    <!-- Tab Content -->
    <div class="tab-content-wrapper">
        <!-- Company Info Tab -->
        <div class="tab-content active" id="company-info">
            <form method="post" enctype="multipart/form-data" class="settings-form">
                {% csrf_token %}
                <input type="hidden" name="form_type" value="company_info">
                
                <!-- Logo & Banner Upload -->
                <div class="form-section">
                    <h3 class="section-title">Logo & Banner Image</h3>
                    <div class="form-row logo-banner-row">
                        <div class="upload-item">
                            <label class="section-subtitle">Upload Logo</label>
                            {% if profile.logo %}
                            <div class="image-preview has-image" id="logo-preview" onclick="document.getElementById('id_logo').click()">
                                <img src="{{ profile.logo.url }}" alt="Company Logo">
                            </div>
                            <div class="upload-actions">
                                {{ profile.logo.size|filesizeformat }}
                            </div>
                            {% else %}
                            <div class="image-preview" id="logo-preview" onclick="document.getElementById('id_logo').click()">
                            </div>
                            {% endif %}
                            {{ company_info_form.logo }}
                        </div>

                        <div class="upload-item">
                            <label class="section-subtitle">Banner Image</label>
                            {% if profile.banner %}
                            <div class="image-preview has-image" id="banner-preview" onclick="document.getElementById('id_banner').click()">
                                <img src="{{ profile.banner.url }}" alt="Banner Image">
                            </div>
                            <div class="upload-actions">
                                {{ profile.banner.size|filesizeformat }}
                            </div>
                            {% else %}
                            <div class="image-preview" id="banner-preview" onclick="document.getElementById('id_banner').click()">
                            </div>
                            {% endif %}
                            {{ company_info_form.banner }}
                        </div>
                    </div>
                </div>

                <!-- Company Name -->
                <div class="form-section">
                    <div class="form-group">
                        <label for="id_company_name">Company name</label>
                        {{ company_info_form.company_name }}
                        {% if not profile.company_name %}
                        <small class="empty-hint">Please enter your company name</small>
                        {% endif %}
                    </div>
                </div>

                <!-- About Us -->
                <div class="form-section">
                    <div class="form-group">
                        <label for="id_about_us">About us</label>
                        {{ company_info_form.about_us }}
                        {% if not profile.about_us %}
                        <small class="empty-hint">Tell candidates about your company</small>
                        {% endif %}
                    </div>
                </div>

                <!-- Save Button -->
                <div class="form-actions">
                    <button type="submit" class="btn-save">Save Change</button>
                </div>
            </form>

            <!-- Business Permit Section -->
            <div class="form-section" style="margin-top: 30px;">
                <div class="section-header">
                    <h3 class="section-title">Business Permit</h3>
                    <button type="button" class="btn-replace-permit" onclick="openPermitModal()">
                        <i class="fas fa-sync-alt"></i> Replace
                    </button>
                </div>
                
                {% if profile.business_permit %}
                <div class="file-item">
                    <i class="fas fa-file-pdf"></i>
                    <div class="file-info">
                        <p>{{ profile.business_permit.name|default:"business_permit.pdf" }}</p>
                        <small>Uploaded</small>
                    </div>
                    <a href="{{ profile.business_permit.url }}" target="_blank" class="btn-view-file">
                        <i class="fas fa-eye"></i> View
                    </a>
                </div>
                {% else %}
                <div class="empty-permit-state">
                    <i class="fas fa-file-contract"></i>
                    <p>No business permit uploaded</p>
                    <small>Upload your business permit (PDF, JPG, PNG - Max 10MB)</small>
                    <button type="button" class="btn-upload-permit" onclick="openPermitModal()">
                        <i class="fas fa-upload"></i> Upload Permit
                    </button>
                </div>
                {% endif %}
            </div>

            <!-- Business Permit Upload Modal -->
            <div id="permitModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>{% if profile.business_permit %}Replace{% else %}Upload{% endif %} Business Permit</h3>
                        <button type="button" class="modal-close" onclick="closePermitModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <form method="post" enctype="multipart/form-data" id="permitForm">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="business_permit">
                        
                        <div class="modal-body">
                            <div class="upload-zone" id="permitUploadZone">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p>Click to browse or drag and drop your file here</p>
                                <small>Supported formats: PDF, JPG, PNG (Max 10MB)</small>
                                {{ business_permit_form.business_permit }}
                            </div>
                            <div id="permitFileName" class="file-name-display"></div>
                        </div>
                        
                        <div class="modal-footer">
                            <button type="button" class="btn-cancel" onclick="closePermitModal()">Cancel</button>
                            <button type="submit" class="btn-save">Upload Permit</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Founding Info Tab -->
        <div class="tab-content" id="founding-info">
            <form method="post" class="settings-form">
                {% csrf_token %}
                <input type="hidden" name="form_type" value="founding_info">
                
                <div class="form-section">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="id_organization_type">Organization Type</label>
                            {{ founding_info_form.organization_type }}
                            {% if not profile.organization_type %}
                            <small class="empty-hint">Select your organization type</small>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label for="id_industry_type">Industry Types</label>
                            {{ founding_info_form.industry_type }}
                            {% if not profile.industry_type %}
                            <small class="empty-hint">Select your industry</small>
                            {% endif %}
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="id_team_size">Team Size</label>
                            {{ founding_info_form.team_size }}
                            {% if not profile.team_size %}
                            <small class="empty-hint">Select your team size</small>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label for="id_year_established">Year of Establishment</label>
                            {{ founding_info_form.year_established }}
                            {% if not profile.year_established %}
                            <small class="empty-hint">When was your company established?</small>
                            {% endif %}
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="id_company_website">Company Website</label>
                        <div class="input-with-icon">
                            <i class="fas fa-link"></i>
                            {{ founding_info_form.company_website }}
                        </div>
                        {% if not profile.company_website %}
                        <small class="empty-hint">Add your company website URL</small>
                        {% endif %}
                    </div>
                </div>

                <!-- Company Vision -->
                <div class="form-section">
                    <div class="form-group">
                        <label for="id_company_vision">Company Vision</label>
                        {{ founding_info_form.company_vision }}
                        {% if not profile.company_vision %}
                        <small class="empty-hint">Share your company's vision and goals</small>
                        {% endif %}
                    </div>
                </div>

                <!-- Save Button -->
                <div class="form-actions">
                    <button type="submit" class="btn-save">Save Changes</button>
                </div>
            </form>
        </div>

        <!-- Account Setting Tab -->
        <div class="tab-content" id="account-setting">
            <!-- Contact Information Form -->
            <form method="post" class="settings-form">
                {% csrf_token %}
                <input type="hidden" name="form_type" value="contact_info">
                
                <div class="form-section">
                    <h3 class="section-title">Contact Information</h3>
                    
                    <div class="form-group">
                        <label for="id_phone_number">Phone</label>
                        {{ contact_info_form.phone_number }}
                        {% if not profile.phone_number %}
                        <small class="empty-hint">Add your contact phone number</small>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="id_email">Email</label>
                        <div class="input-with-icon">
                            <i class="fas fa-envelope"></i>
                            {{ contact_info_form.email }}
                        </div>
                        <small class="form-hint">This email is used for login and notifications</small>
                    </div>

                    <div class="form-group">
                        <label for="id_contact_email">Contact Email</label>
                        <div class="input-with-icon">
                            <i class="fas fa-envelope"></i>
                            {{ contact_info_form.contact_email }}
                        </div>
                        {% if not profile.contact_email %}
                        <small class="empty-hint">Add a contact email for applicants</small>
                        {% endif %}
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-save">Save Changes</button>
                </div>
            </form>

            <!-- Change Password Form -->
            <form method="post" class="settings-form" style="margin-top: 30px;">
                {% csrf_token %}
                <input type="hidden" name="form_type" value="change_password">
                
                <div class="form-section">
                    {% if password_form.errors %}
                    <div class="form-errors">
                        <ul>
                            {% for field, errors in password_form.errors.items %}
                                {% for err in errors %}
                                <li class="error-item">{{ err }}</li>
                                {% endfor %}
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    <h3 class="section-title">Change Password</h3>
                    
                    <div class="form-group">
                        <label for="id_old_password">Current Password</label>
                        <div class="password-input">
                            {{ password_form.old_password }}
                            <button type="button" class="toggle-password" onclick="togglePassword('id_old_password', this)">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="id_new_password1">New Password</label>
                            <div class="password-input">
                                {{ password_form.new_password1 }}
                                <button type="button" class="toggle-password" onclick="togglePassword('id_new_password1', this)">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="id_new_password2">Confirm Password</label>
                            <div class="password-input">
                                {{ password_form.new_password2 }}
                                <button type="button" class="toggle-password" onclick="togglePassword('id_new_password2', this)">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <ul class="password-requirements">
                        <li><i class="fas fa-info-circle"></i> Password must be at least 8 characters</li>
                        <li><i class="fas fa-info-circle"></i> Cannot be too similar to your other personal information</li>
                        <li><i class="fas fa-info-circle"></i> Cannot be entirely numeric</li>
                    </ul>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-save">Change Password</button>
                </div>
            </form>

            <!-- Delete Company Section -->
            <div class="form-section danger-zone" style="margin-top: 40px;">
                <h3 class="section-title">Delete Your Company Account</h3>
                <p class="danger-text">
                    If you delete your JobConnect company account, you will no longer be able to post jobs, 
                    view applications, or access any employer services. This action cannot be undone.
                </p>
                <button type="button" class="btn-close-account" id="close-account-btn">
                    <i class="fas fa-times-circle"></i>
                    Close Account
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Tab switching
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const targetTab = this.getAttribute('data-tab');
        
        // Remove active classes
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        // Add active classes
        this.classList.add('active');
        document.getElementById(targetTab).classList.add('active');
    });
});

// Password toggle function
function togglePassword(inputId, button) {
    const input = document.getElementById(inputId);
    const icon = button.querySelector('i');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

// File input preview for logo
const logoInput = document.getElementById('id_logo');
if (logoInput) {
    logoInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const preview = document.getElementById('logo-preview');
                
                if (preview) {
                    preview.innerHTML = `<img src="${event.target.result}" alt="Logo Preview">`;
                    preview.classList.add('has-image');
                    preview.onclick = function() { document.getElementById('id_logo').click(); };
                    
                    // Update or create file size display
                    let actions = preview.nextElementSibling;
                    if (!actions || !actions.classList.contains('upload-actions')) {
                        actions = document.createElement('div');
                        actions.className = 'upload-actions';
                        preview.parentElement.insertBefore(actions, logoInput);
                    }
                    
                    const fileSize = file.size < 1024 * 1024 
                        ? `${(file.size / 1024).toFixed(1)} KB` 
                        : `${(file.size / 1024 / 1024).toFixed(1)} MB`;
                    actions.textContent = fileSize;
                }
            };
            reader.readAsDataURL(file);
        }
    });
}

// File input preview for banner
const bannerInput = document.getElementById('id_banner');
if (bannerInput) {
    bannerInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const preview = document.getElementById('banner-preview');
                
                if (preview) {
                    preview.innerHTML = `<img src="${event.target.result}" alt="Banner Preview">`;
                    preview.classList.add('has-image');
                    preview.onclick = function() { document.getElementById('id_banner').click(); };
                    
                    // Update or create file size display
                    let actions = preview.nextElementSibling;
                    if (!actions || !actions.classList.contains('upload-actions')) {
                        actions = document.createElement('div');
                        actions.className = 'upload-actions';
                        preview.parentElement.insertBefore(actions, bannerInput);
                    }
                    
                    const fileSize = file.size < 1024 * 1024 
                        ? `${(file.size / 1024).toFixed(1)} KB` 
                        : `${(file.size / 1024 / 1024).toFixed(1)} MB`;
                    actions.textContent = fileSize;
                }
            };
            reader.readAsDataURL(file);
        }
    });
}

// Close account confirmation
const closeBtn = document.getElementById('close-account-btn');
if (closeBtn) {
    closeBtn.addEventListener('click', function() {
        if (confirm('Are you sure you want to permanently delete your company account? This action cannot be undone.')) {
            alert('Account deletion feature will be implemented');
        }
    });
}

// Auto-dismiss messages after 5 seconds
setTimeout(function() {
    const messages = document.querySelector('.messages-container');
    if (messages) {
        messages.style.opacity = '0';
        setTimeout(() => messages.remove(), 300);
    }
}, 5000);

// Business Permit Modal Functions
function openPermitModal() {
    const modal = document.getElementById('permitModal');
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closePermitModal() {
    const modal = document.getElementById('permitModal');
    modal.classList.remove('active');
    document.body.style.overflow = 'auto';
    
    // Reset form
    const form = document.getElementById('permitForm');
    form.reset();
    
    const fileNameDisplay = document.getElementById('permitFileName');
    fileNameDisplay.classList.remove('active');
    fileNameDisplay.textContent = '';
}

// Close modal when clicking outside
document.addEventListener('click', function(e) {
    const modal = document.getElementById('permitModal');
    if (e.target === modal) {
        closePermitModal();
    }
});

// Handle file selection in modal
const permitFileInput = document.querySelector('#permitModal input[type="file"]');
if (permitFileInput) {
    permitFileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        const fileNameDisplay = document.getElementById('permitFileName');
        
        if (file) {
            const fileSize = file.size < 1024 * 1024 
                ? `${(file.size / 1024).toFixed(1)} KB` 
                : `${(file.size / 1024 / 1024).toFixed(1)} MB`;
            
            fileNameDisplay.innerHTML = `
                <i class="fas fa-file-pdf"></i>
                <strong>${file.name}</strong> (${fileSize})
            `;
            fileNameDisplay.classList.add('active');
        } else {
            fileNameDisplay.classList.remove('active');
            fileNameDisplay.textContent = '';
        }
    });
}
</script>
{% endblock %}
