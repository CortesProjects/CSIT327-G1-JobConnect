{% extends "dashboard/employer/employer_dashboard_base.html" %}
{% load static %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/dashboard/employer/employer_settings.css' %}">
{% endblock %}

{% block dashboard_content %}
<div class="settings-container">
    <h1 class="page-title">Settings</h1>

    <!-- Tabs Navigation -->
    <div class="settings-tabs">
        <button class="tab-btn active" data-tab="company-info" id="company-info-tab">
            <i class="fas fa-building"></i>
            Company Info
        </button>
        <button class="tab-btn" data-tab="founding-info" id="founding-info-tab">
            <i class="fas fa-globe"></i>
            Founding Info
        </button>
        <button class="tab-btn" data-tab="social-links" id="social-links-tab">
            <i class="fas fa-share-alt"></i>
            Social Links
        </button>
        <button class="tab-btn" data-tab="account-setting" id="account-setting-tab">
            <i class="fas fa-cog"></i>
            Account Setting
        </button>
    </div>

    <!-- Tab Content -->
    <div class="tab-content-wrapper">
        <!-- Company Info Tab -->
        <div class="tab-content active" id="company-info">
            <form method="post" enctype="multipart/form-data" class="settings-form">
                {% csrf_token %}
                <input type="hidden" name="form_type" value="company_info">
                
                <!-- Logo & Banner Upload -->
                <div class="form-section">
                    <h3 class="section-title">Logo & Banner Image</h3>
                    <div class="form-row logo-banner-row">
                        <div class="upload-item">
                            <label class="section-subtitle">Upload Logo</label>
                            {% if profile.company_profile_image %}
                                <div class="image-preview-setup has-image square-logo-area" id="logo-preview" onclick="clickInputByFieldName('company_profile_image')">
                                    <img src="{{ profile.company_profile_image.url }}" alt="Company Logo">
                                    <div class="hover-overlay-setup">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                        <p><span>Change photo</span> or drop here</p>
                                        <small>Max photo size 5 MB</small>
                                    </div>
                                </div>
                                <div class="upload-actions">
                                    {{ profile.company_profile_image.size|filesizeformat }}
                                </div>
                            {% else %}
                                <div class="image-preview-setup square-logo-area" id="logo-preview" onclick="clickInputByFieldName('company_profile_image')">
                                    <div class="upload-content-placeholder">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                        <h4>Upload company logo</h4>
                                        <p class="upload-hint">PNG or JPG. Preferably 400x400px. Max 5 MB.</p>
                                    </div>
                                    <div class="hover-overlay-setup">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                        <p><span>Browse photo</span> or drop here</p>
                                        <small>Max photo size 5 MB</small>
                                    </div>
                                </div>
                            {% endif %}
                            <div style="display: none;">
                                {{ company_info_form.company_profile_image }}
                            </div>
                        </div>

                        <div class="upload-item">
                            <label class="section-subtitle">Banner Image</label>
                            {% if profile.company_banner_image %}
                            <div class="image-preview-setup has-image banner-preview-area" id="banner-preview" onclick="clickInputByFieldName('company_banner_image')">
                                <img src="{{ profile.company_banner_image.url }}" alt="Banner Image">
                                <div class="hover-overlay-setup">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <p><span>Change photo</span> or drop here</p>
                                    <small>Max photo size 5 MB</small>
                                </div>
                            </div>
                            <div class="upload-actions">
                                {{ profile.company_banner_image.size|filesizeformat }}
                            </div>
                            {% else %}
                            <div class="image-preview-setup banner-preview-area" id="banner-preview" onclick="clickInputByFieldName('company_banner_image')">
                                <div class="upload-content-placeholder">
                                    <i class="fas fa-image"></i>
                                    <h4>Upload banner image</h4>
                                    <p class="upload-hint">Recommended 1200x300px. PNG or JPG. Max 5 MB.</p>
                                </div>
                                <div class="hover-overlay-setup">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <p><span>Browse photo</span> or drop here</p>
                                    <small>Max photo size 5 MB</small>
                                </div>
                            </div>
                            {% endif %}
                            <div style="display: none;">
                                {{ company_info_form.company_banner_image }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Company Name -->
                <div class="form-section">
                    <div class="form-group">
                        <label for="id_company_name">Company name</label>
                        {{ company_info_form.company_name }}
                        {% if not profile.company_name %}
                        <small class="empty-hint">Please enter your company name</small>
                        {% endif %}
                    </div>
                </div>

                <!-- About Us -->
                <div class="form-section">
                    <div class="form-group">
                        <label for="id_about_us">About us</label>
                        {{ company_info_form.about_us }}
                        {% if not profile.about_us %}
                        <small class="empty-hint">Tell candidates about your company</small>
                        {% endif %}
                    </div>
                </div>

                <!-- Save Button -->
                <div class="form-actions">
                    <button type="submit" class="btn-save">Save Change</button>
                </div>
            </form>

            <!-- Business Permit Section -->
            <div class="form-section" style="margin-top: 30px;">
                <div class="section-header">
                    <h3 class="section-title">Business Permit</h3>
                    <button type="button" class="btn-replace-permit" onclick="openPermitModal()">
                        <i class="fas fa-sync-alt"></i> Replace
                    </button>
                </div>
                
                {% if profile.company_business_permit %}
                <div class="file-item">
                    <i class="fas fa-file-pdf"></i>
                    <div class="file-info">
                        <p>{{ profile.company_business_permit.name|default:"business_permit.pdf" }}</p>
                        <small>Uploaded</small>
                    </div>
                    <a href="{{ profile.company_business_permit.url }}" target="_blank" class="btn-view-file">
                        <i class="fas fa-eye"></i> View
                    </a>
                </div>
                {% else %}
                <div class="empty-permit-state">
                    <i class="fas fa-file-contract"></i>
                    <p>No business permit uploaded</p>
                    <small>Upload your business permit (PDF, JPG, PNG - Max 10MB)</small>
                    <button type="button" class="btn-upload-permit" onclick="openPermitModal()">
                        <i class="fas fa-upload"></i> Upload Permit
                    </button>
                </div>
                {% endif %}
            </div>

            <!-- Business Permit Upload Modal -->
            <div id="permitModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>{% if profile.business_permit %}Replace{% else %}Upload{% endif %} Business Permit</h3>
                        <button type="button" class="modal-close" onclick="closePermitModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <form method="post" enctype="multipart/form-data" id="permitForm">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="business_permit">
                        
                        <div class="modal-body">
                            <div class="upload-zone" id="permitUploadZone">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p>Click to browse or drag and drop your file here</p>
                                <small>Supported formats: PDF, JPG, PNG (Max 10MB)</small>
                                {{ business_permit_form.company_business_permit }}
                            </div>
                            <div id="permitFileName" class="file-name-display"></div>
                        </div>
                        
                        <div class="modal-footer">
                            <button type="button" class="btn-cancel" onclick="closePermitModal()">Cancel</button>
                            <button type="submit" class="btn-save">Upload Permit</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Founding Info Tab -->
        <div class="tab-content" id="founding-info">
            <form method="post" class="settings-form">
                {% csrf_token %}
                <input type="hidden" name="form_type" value="founding_info">
                
                <div class="form-section">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="id_organization_type">Organization Type</label>
                            {{ founding_info_form.organization_type }}
                            {% if not profile.organization_type %}
                            <small class="empty-hint">Select your organization type</small>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label for="id_industry_type">Industry Types</label>
                            {{ founding_info_form.industry_type }}
                            {% if not profile.industry_type %}
                            <small class="empty-hint">Select your industry</small>
                            {% endif %}
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="id_team_size">Team Size</label>
                            {{ founding_info_form.team_size }}
                            {% if not profile.team_size %}
                            <small class="empty-hint">Select your team size</small>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label for="id_year_established">Year of Establishment</label>
                            {{ founding_info_form.year_established }}
                            {% if not profile.year_established %}
                            <small class="empty-hint">When was your company established?</small>
                            {% endif %}
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="id_company_website">Company Website</label>
                        <div class="input-with-icon">
                            <i class="fas fa-link"></i>
                            {{ founding_info_form.company_website }}
                        </div>
                        {% if not profile.company_website %}
                        <small class="empty-hint">Add your company website URL</small>
                        {% endif %}
                    </div>
                </div>

                <!-- Company Vision -->
                <div class="form-section">
                    <div class="form-group">
                        <label for="id_company_vision">Company Vision</label>
                        {{ founding_info_form.company_vision }}
                        {% if not profile.company_vision %}
                        <small class="empty-hint">Share your company's vision and goals</small>
                        {% endif %}
                    </div>
                </div>

                <!-- Save Button -->
                <div class="form-actions">
                    <button type="submit" class="btn-save">Save Changes</button>
                </div>
            </form>
        </div>

        <!-- Account Setting Tab -->
        <div class="tab-content" id="account-setting">
            <!-- Contact Information Form -->
            <form method="post" class="settings-form">
                {% csrf_token %}
                <input type="hidden" name="form_type" value="contact_info">
                
                <div class="form-section">
                    <h3 class="section-title">Contact Information</h3>
                    
                    <div class="form-group">
                        <label for="id_contact_phone_number">Phone</label>
                        {{ contact_info_form.contact_phone_number }}
                        {% if not profile.contact_phone_number %}
                        <small class="empty-hint">Add your contact phone number</small>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="id_email">Email</label>
                        <div class="input-with-icon">
                            <i class="fas fa-envelope"></i>
                            {{ contact_info_form.email }}
                        </div>
                        <small class="form-hint">This email is used for login and notifications</small>
                    </div>

                    <div class="form-group">
                        <label for="id_contact_email">Contact Email</label>
                        <div class="input-with-icon">
                            <i class="fas fa-envelope"></i>
                            {{ contact_info_form.contact_email }}
                        </div>
                        {% if not profile.contact_email %}
                        <small class="empty-hint">Add a contact email for applicants</small>
                        {% endif %}
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-save">Save Changes</button>
                </div>
            </form>

            <!-- Change Password Form -->
            <form method="post" class="settings-form" style="margin-top: 30px;">
                {% csrf_token %}
                <input type="hidden" name="form_type" value="change_password">
                
                <div class="form-section">
                    <h3 class="section-title">Change Password</h3>
                    <div class="form-row-three-columns">
                        <div class="form-group">
                            <label for="{{ password_form.old_password.id_for_label }}">Current Password</label>
                            <div class="input-with-icon">
                                {{ password_form.old_password }}
                                <i class="fas fa-eye toggle-password"></i>
                            </div>
                            {% if password_form.old_password.errors %}
                                <div class="error-text">{{ password_form.old_password.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            <label for="{{ password_form.new_password1.id_for_label }}">New Password</label>
                            <div class="input-with-icon">
                                {{ password_form.new_password1 }}
                                <i class="fas fa-eye toggle-password"></i>
                            </div>
                            {% if password_form.new_password1.errors %}
                                <div class="error-text">{{ password_form.new_password1.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            <label for="{{ password_form.new_password2.id_for_label }}">Confirm Password</label>
                            <div class="input-with-icon">
                                {{ password_form.new_password2 }}
                                <i class="fas fa-eye toggle-password"></i>
                            </div>
                            {% if password_form.new_password2.errors %}
                                <div class="error-text">{{ password_form.new_password2.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <button type="submit" class="btn-save">Save Changes</button>
                </div>
            </form>

            <hr>  
            <div class="account-section-block delete-account-section">
                <h3>Delete Your Company Account</h3>
                <p class="delete-warning">If you delete your JobConnect company account, you will no longer be able to post jobs, view applications, or access any employer services. This action is <strong>permanent and cannot be undone</strong>.</p>
                <button type="button" class="btn-delete-account" id="delete-account-btn">
                    <i class="fas fa-exclamation-triangle"></i> Delete Account
                </button>
            </div>
            
            <!-- Delete Account Confirmation Modal -->
            <div class="modal" id="deleteAccountModal">
                <div class="modal-content delete-confirm-modal">
                    <button type="button" class="modal-close" onclick="closeDeleteAccountModal()">
                        <i class="fas fa-times"></i>
                    </button>
                    
                    <div class="delete-modal-header">
                        <i class="fas fa-exclamation-circle"></i>
                        <h2>Delete Company Account?</h2>
                    </div>
                    
                    <div class="delete-modal-body">
                        <p>Are you absolutely sure you want to delete your company account? This will:</p>
                        <ul>
                            <li>Permanently delete your company profile and all information</li>
                            <li>Remove all your job postings</li>
                            <li>Delete all received applications</li>
                            <li>Cancel any ongoing recruitment processes</li>
                        </ul>
                        <p><strong>This action cannot be undone!</strong></p>
                        
                        <form method="post" id="deleteAccountForm">
                            {% csrf_token %}
                            <input type="hidden" name="form_type" value="delete_account">
                            
                            <div class="form-group" style="margin-top: 20px;">
                                <label for="delete-confirm-text">Type <strong>DELETE</strong> to confirm:</label>
                                <input type="text" id="delete-confirm-text" class="form-control" placeholder="Type DELETE" autocomplete="off" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="delete-password">Enter your password to confirm:</label>
                                <div class="input-with-icon">
                                    <input type="password" id="delete-password" name="password" class="form-control" placeholder="Your password" required>
                                    <i class="fas fa-eye toggle-password"></i>
                                </div>
                            </div>
                            
                            <div class="modal-actions">
                                <button type="button" class="btn-cancel" onclick="closeDeleteAccountModal()">Cancel</button>
                                <button type="submit" class="btn-delete-confirm" id="confirm-delete-btn" disabled>
                                    <i class="fas fa-trash"></i> Delete My Company Account
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Social Links Tab -->
        <div class="tab-content" id="social-links">
            <form method="post" id="social-links-form" class="settings-form">
                {% csrf_token %}
                <input type="hidden" name="form_type" value="social_links_bulk">
                
                <div class="form-section">
                    <h3 class="section-title">Social Media Links</h3>
                    <p class="section-description">Add your company's social media profiles to help candidates connect with you</p>
                    
                    <div id="social-links-list">
                        {% if social_links %}
                            {% for link in social_links %}
                            <div class="social-link-item" data-link-id="{{ link.id }}">
                                <div class="social-link-input-group">
                                    <select name="platform[]" class="social-platform-select">
                                        {% for value, label in social_link_form.fields.platform.choices %}
                                            <option value="{{ value }}" {% if link.platform == value %}selected{% endif %}>{{ label }}</option>
                                        {% endfor %}
                                    </select>
                                    <input type="url" name="url[]" value="{{ link.url }}" placeholder="Profile link/url..." class="social-link-input">
                                    <input type="hidden" name="link_id[]" value="{{ link.id }}">
                                    <button type="button" class="btn-icon-action btn-delete-link" data-action="delete-link" title="Delete">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="empty-social-message">No social links added yet. Click the button below to add your first social link.</p>
                        {% endif %}
                    </div>
                    
                    <div id="add-social-link-form" class="social-link-form is-hidden">
                        <div class="social-link-item new-link-item">
                            <div class="social-link-input-group">
                                <select id="new-platform" class="social-platform-select">
                                    {% for value, label in social_link_form.fields.platform.choices %}
                                        <option value="{{ value }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                                <input type="url" id="new-url" placeholder="Profile link/url..." class="social-link-input">
                                <button type="button" class="btn-icon-action btn-confirm-add" data-action="confirm-add" title="Add">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button type="button" class="btn-icon-action btn-cancel-add" data-action="cancel-add-social-link" title="Cancel">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" class="btn-add-social-link" data-action="show-add-social-link">
                        <i class="fas fa-plus-circle"></i> Add New Social Link
                    </button>
                    
                    <button type="submit" class="btn-save is-hidden" id="save-social-changes">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Helper: click file input by id or by name
function clickInputByFieldName(fieldName) {
    const byId = document.getElementById('id_' + fieldName);
    if (byId) { byId.click(); return; }
    const byName = document.querySelector('input[name="' + fieldName + '"]');
    if (byName) { byName.click(); return; }
}

// Tab switching
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const targetTab = this.getAttribute('data-tab');
        
        // Remove active classes
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        // Add active classes
        this.classList.add('active');
        document.getElementById(targetTab).classList.add('active');
    });
});

// File input preview for logo
const logoInput = document.getElementById('id_company_profile_image') || document.querySelector('input[name="company_profile_image"]');
if (logoInput) {
    logoInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const preview = document.getElementById('logo-preview');
                
                if (preview) {
                    preview.innerHTML = `<img src="${event.target.result}" alt="Logo Preview">`;
                    preview.classList.add('has-image');
                    preview.onclick = function() { clickInputByFieldName('company_profile_image'); };
                    
                    // Update or create file size display
                    let actions = preview.nextElementSibling;
                    if (!actions || !actions.classList.contains('upload-actions')) {
                        actions = document.createElement('div');
                        actions.className = 'upload-actions';
                        preview.parentElement.insertBefore(actions, logoInput);
                    }
                    
                    const fileSize = file.size < 1024 * 1024 
                        ? `${(file.size / 1024).toFixed(1)} KB` 
                        : `${(file.size / 1024 / 1024).toFixed(1)} MB`;
                    actions.textContent = fileSize;
                }
            };
            reader.readAsDataURL(file);
        }
    });
}

// File input preview for banner
const bannerInput = document.getElementById('id_company_banner_image');
if (bannerInput) {
    bannerInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const preview = document.getElementById('banner-preview');
                
                if (preview) {
                    preview.innerHTML = `<img src="${event.target.result}" alt="Banner Preview">`;
                    preview.classList.add('has-image');
                    preview.onclick = function() { document.getElementById('id_company_banner_image').click(); };
                    
                    // Update or create file size display
                    let actions = preview.nextElementSibling;
                    if (!actions || !actions.classList.contains('upload-actions')) {
                        actions = document.createElement('div');
                        actions.className = 'upload-actions';
                        preview.parentElement.insertBefore(actions, bannerInput);
                    }
                    
                    const fileSize = file.size < 1024 * 1024 
                        ? `${(file.size / 1024).toFixed(1)} KB` 
                        : `${(file.size / 1024 / 1024).toFixed(1)} MB`;
                    actions.textContent = fileSize;
                }
            };
            reader.readAsDataURL(file);
        }
    });
}

// Business Permit Modal Functions
function openPermitModal() {
    const modal = document.getElementById('permitModal');
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closePermitModal() {
    const modal = document.getElementById('permitModal');
    modal.classList.remove('active');
    document.body.style.overflow = 'auto';
    
    // Reset form
    const form = document.getElementById('permitForm');
    form.reset();
    
    const fileNameDisplay = document.getElementById('permitFileName');
    fileNameDisplay.classList.remove('active');
    fileNameDisplay.textContent = '';
}

// Make the permit upload zone clickable and show selected filename
const permitZone = document.getElementById('permitUploadZone');
const permitInput = document.getElementById('id_company_business_permit');
const permitFileName = document.getElementById('permitFileName');
if (permitZone && permitInput) {
    permitZone.addEventListener('click', function() { permitInput.click(); });
    permitInput.addEventListener('change', function(e) {
        const f = e.target.files[0];
        if (f) {
            permitFileName.textContent = f.name;
            permitFileName.classList.add('active');
        } else {
            permitFileName.textContent = '';
            permitFileName.classList.remove('active');
        }
    });
}

// Close modal when clicking outside
document.addEventListener('click', function(e) {
    const modal = document.getElementById('permitModal');
    if (e.target === modal) {
        closePermitModal();
    }
});

// Handle file selection in modal
const permitFileInput = document.querySelector('#permitModal input[type="file"]');
if (permitFileInput) {
    permitFileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        const fileNameDisplay = document.getElementById('permitFileName');
        
        if (file) {
            const fileSize = file.size < 1024 * 1024 
                ? `${(file.size / 1024).toFixed(1)} KB` 
                : `${(file.size / 1024 / 1024).toFixed(1)} MB`;
            
            fileNameDisplay.innerHTML = `
                <i class="fas fa-file-pdf"></i>
                <strong>${file.name}</strong> (${fileSize})
            `;
            fileNameDisplay.classList.add('active');
        } else {
            fileNameDisplay.classList.remove('active');
            fileNameDisplay.textContent = '';
        }
    });
}

// ===== SOCIAL LINKS FUNCTIONALITY =====

// Show/hide add new link form
const addSocialLinkBtn = document.querySelector('[data-action="show-add-social-link"]');
const addSocialForm = document.getElementById('add-social-link-form');
const saveChangesBtn = document.getElementById('save-social-changes');

if (addSocialLinkBtn && addSocialForm) {
    addSocialLinkBtn.addEventListener('click', function() {
        addSocialForm.classList.remove('is-hidden');
        addSocialLinkBtn.classList.add('is-hidden');
    });
}

// Cancel add new link
const cancelAddBtn = document.querySelector('[data-action="cancel-add-social-link"]');
if (cancelAddBtn) {
    cancelAddBtn.addEventListener('click', function() {
        addSocialForm.classList.add('is-hidden');
        addSocialLinkBtn.classList.remove('is-hidden');
        
        // Clear inputs
        document.getElementById('new-platform').value = '';
        document.getElementById('new-url').value = '';
    });
}

// Confirm add new link (adds to list, doesn't submit)
const confirmAddBtn = document.querySelector('[data-action="confirm-add"]');
if (confirmAddBtn) {
    confirmAddBtn.addEventListener('click', function() {
        const platform = document.getElementById('new-platform').value;
        const url = document.getElementById('new-url').value;
        
        // Note: No client-side validation - Django handles all validation
        // Just skip if URL is empty (UI convenience only)
        if (!url.trim()) {
            return;
        }
        
        // Add link to the list
        const linksList = document.getElementById('social-links-list');
        
        // Remove empty message if it exists
        const emptyMsg = linksList.querySelector('.empty-social-message');
        if (emptyMsg) {
            emptyMsg.remove();
        }
        
        // Create new link item
        const newLinkItem = document.createElement('div');
        newLinkItem.className = 'social-link-item';
        newLinkItem.innerHTML = `
            <div class="social-link-input-group">
                <select name="platform[]" class="social-platform-select">
                    ${Array.from(document.getElementById('new-platform').options).map(opt => 
                        `<option value="${opt.value}" ${opt.value === platform ? 'selected' : ''}>${opt.text}</option>`
                    ).join('')}
                </select>
                <input type="url" name="url[]" value="${url}" placeholder="Profile link/url..." class="social-link-input">
                <input type="hidden" name="link_id[]" value="">
                <button type="button" class="btn-icon-action btn-delete-link" data-action="delete-link" title="Delete">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        linksList.appendChild(newLinkItem);
        
        // Show save button
        saveChangesBtn.classList.remove('is-hidden');
        
        // Hide add form and show add button
        addSocialForm.classList.add('is-hidden');
        addSocialLinkBtn.classList.remove('is-hidden');
        
        // Clear inputs
        document.getElementById('new-platform').value = '';
        document.getElementById('new-url').value = '';
        
        // Attach delete handler to the new button
        const deleteBtn = newLinkItem.querySelector('[data-action="delete-link"]');
        deleteBtn.addEventListener('click', handleDeleteLink);
    });
}

// Delete link handler
function handleDeleteLink(e) {
    const linkItem = e.target.closest('.social-link-item');
    if (linkItem) {
        linkItem.remove();
        
        // Show save button
        saveChangesBtn.classList.remove('is-hidden');
        
        // Check if list is now empty
        const linksList = document.getElementById('social-links-list');
        if (linksList.children.length === 0) {
            linksList.innerHTML = '<p class="empty-social-message">No social links added yet. Click the button below to add your first social link.</p>';
        }
    }
}

// Attach delete handlers to existing links
document.querySelectorAll('[data-action="delete-link"]').forEach(btn => {
    btn.addEventListener('click', handleDeleteLink);
});

// Track changes to existing links
document.querySelectorAll('.social-link-item input, .social-link-item select').forEach(input => {
    input.addEventListener('input', function() {
        saveChangesBtn.classList.remove('is-hidden');
    });
});
</script>

<script src="{% static 'js/dashboard/employer/employer_settings.js' %}"></script>
{% endblock %}
