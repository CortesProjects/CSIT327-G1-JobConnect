{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/jobs/job_search.css' %}">
{% endblock %}

{% block title %}Job Search Results{% endblock %}

{% block content %}
<div class="search-results-page">

  <!-- TOP SEARCH BAR -->
  <div class="top-search-bar">
    <form class="top-search-form" method="get" action="{% url 'jobs:job_search' %}" id="top-search-form">
      <div class="search-input-wrapper">
        <i class="fas fa-search search-icon"></i>
        <input type="text" name="query" value="{{ query|default:'' }}" placeholder="Job title, Keyword..." class="top-search-input" autocomplete="off">
      </div>

      <button type="button" id="filter-toggle-btn" class="filter-toggle-btn" title="Open filters">
        <i class="fas fa-filter"></i>
      </button>

      <button type="submit" class="find-btn">Find</button>
    </form>

    <div class="sort-block">
      <label class="sort-label">Sort by:</label>
      <select name="sort" class="sort-select" onchange="location.search = updateQueryStringParameter(location.search, 'sort', this.value)">
        <option value="recent" {% if sort == 'recent' %}selected{% endif %}>Most Recent</option>
        <option value="salary_low" {% if sort == 'salary_low' %}selected{% endif %}>
        Salary: Low to High
        </option>
        <option value="salary_high" {% if sort == 'salary_high' %}selected{% endif %}>
        Salary: High to Low
      </option>
      </select>
    </div>
  </div>

  <!-- FILTER DRAWER -->
  <div id="filter-drawer" class="filter-drawer" aria-hidden="true">
    <form method="get" id="filters-form" class="filters-form-inner">

      <!-- Persist Search -->
      <input type="hidden" name="query" value="{{ query|default:'' }}">
      <input type="hidden" name="location" value="{{ location|default:'' }}">

      <div class="filters-row">

        <!-- JOB TYPE DROPDOWN -->
        <div class="filter-field">
          <label class="filter-heading">Job Type</label>
          <select name="job_type" class="filter-select">
            <option value="">All</option>
            {% for jt in job_types %}
              <option value="{{ jt.id }}" {% if jt.id|stringformat:"s" in selected_job_types %}selected{% endif %}>{{ jt.name }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- CATEGORY DROPDOWN -->
        <div class="filter-field">
          <label class="filter-heading">Category</label>
          <select name="category" class="filter-select">
            <option value="">All</option>
            {% for cat in categories %}
              <option value="{{ cat.id }}" {% if cat.id|stringformat:"s" in selected_categories %}selected{% endif %}>{{ cat.name }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- EDUCATION DROPDOWN -->
        <div class="filter-field">
          <label class="filter-heading">Education</label>
          <select name="education" class="filter-select">
            <option value="">All</option>
            {% for ed in educations %}
              <option value="{{ ed.id }}" {% if ed.id|stringformat:"s" in selected_educations %}selected{% endif %}>{{ ed.name }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- EXPERIENCE DROPDOWN -->
        <div class="filter-field">
          <label class="filter-heading">Experience</label>
          <select name="experience" class="filter-select">
            <option value="">All</option>
            {% for ex in experiences %}
              <option value="{{ ex.id }}" {% if ex.id|stringformat:"s" in selected_experiences %}selected{% endif %}>{{ ex.name }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- JOB LEVEL DROPDOWN -->
        <div class="filter-field">
          <label class="filter-heading">Level</label>
          <select name="job_level" class="filter-select">
            <option value="">All</option>
            {% for lvl in job_levels %}
              <option value="{{ lvl.id }}" {% if lvl.id|stringformat:"s" in selected_job_levels %}selected{% endif %}>{{ lvl.name }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- SALARY RANGE -->
        <div class="filter-field salary-range-field">
          <label class="filter-heading">Salary range</label>
          <div class="salary-inputs" style="display:flex; gap:8px; align-items:center;">
            <input type="number" name="salary_min" value="{{ salary_min|default_if_none:'' }}" placeholder="Min" min="0" step="0.01" style="width:120px;">
            <span>—</span>
            <input type="number" name="salary_max" value="{{ salary_max|default_if_none:'' }}" placeholder="Max" min="0" step="0.01" style="width:120px;">
          </div>
        </div>

      </div>

      <div class="filters-actions" style="margin-top:12px;">
        <button type="submit" class="apply-filters-btn">Apply Filters</button>
        <a href="{% url 'jobs:job_search' %}" class="clear-filters-btn">Clear</a>
        <button type="button" id="filter-close-btn" class="filter-close-btn">Close</button>
      </div>
    </form>
  </div>

  <!-- RESULTS -->
  <div class="content-wrapper no-sidebar">
    <section class="results-section">

      <div class="results-header">
        <div class="results-count">
          {% if jobs %}
            <strong>{{ jobs.count }}</strong> job{% if jobs.count != 1 %}s{% endif %} found
          {% else %}
            <strong>0</strong> jobs found
          {% endif %}
        </div>
      </div>

      <div class="results-table-header">
        <div class="col job-details-col">JOB DETAILS</div>
        <div class="col location-col">LOCATION</div>
        <div class="col salary-col">SALARY</div>
        <div class="col posted-col">POSTED</div>
        <div class="col actions-col">ACTIONS</div>
      </div>

      {% if jobs %}
        <div class="job-list">
          {% for job in jobs %}
          <div class="results-row">

            <!-- JOB DETAILS -->
            <div class="col job-details-col">
              <a href="{% url 'jobs:job_detail' job.id %}" class="job-link">

                <div class="company-logo">
                  {% if job.employer.employer_profile_rel and job.employer.employer_profile_rel.company_profile_image %}
                    <img src="{{ job.employer.employer_profile_rel.company_profile_image.url }}"
                         alt="{{ job.company_name }}"
                         class="company-logo-img">
                  {% else %}
                    <div class="logo-fallback">{{ job.title|first|upper }}</div>
                  {% endif %}
                </div>

                <div class="job-main">
                  <h4 class="job-title">{{ job.title }}</h4>
                  <div class="employer-sub">{{ job.company_name|default:"employer" }}</div>
                </div>
              </a>
            </div>

            <!-- LOCATION -->
            <div class="col location-col">
              <i class="fas fa-map-marker-alt"></i>
              <span class="location-text">{{ job.location }}</span>
            </div>

            <!-- SALARY -->
            <div class="col salary-col">
              <i class="fas fa-money-bill-wave"></i>
              {% if job.min_salary %}
                {% if job.max_salary %}
                  <span class="salary-range">₱{{ job.min_salary|intcomma }} - ₱{{ job.max_salary|intcomma }}</span>
                {% else %}
                  <span class="salary-range">₱{{ job.min_salary|intcomma }}+</span>
                {% endif %}
              {% elif job.max_salary %}
                <span class="salary-range">Up to ₱{{ job.max_salary|intcomma }}</span>
              {% else %}
                <span class="salary-range text-muted">Not Specified</span>
              {% endif %}
            </div>

            <!-- POSTED -->
            <div class="col posted-col">
              <i class="far fa-clock"></i>
              {% if job.posted_at %}
                <span>{{ job.posted_at|timesince }} ago</span>
              {% else %}
                <span>-</span>
              {% endif %}
            </div>

            <!-- ACTIONS -->
            <div class="col actions-col">
              <a href="{% url 'jobs:job_detail' job.id %}" class="btn view-details-btn">View details <i class="fas fa-arrow-right"></i></a>

              {% if user.is_authenticated and user.user_type == 'applicant' %}
              <form method="post" action="{% url 'jobs:toggle_favorite_job' job.id %}" class="favorite-form">
                {% csrf_token %}
                <button type="submit" class="bookmark-btn {% if job.id in favorited_job_ids %}active{% endif %}">
                  <i class="{% if job.id in favorited_job_ids %}fas fa-bookmark{% else %}far fa-bookmark{% endif %}"></i>
                </button>
              </form>
              {% else %}
                <button class="bookmark-btn guest" disabled><i class="far fa-bookmark"></i></button>
              {% endif %}
            </div>

          </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="no-results">
          <img src="{% static 'img/no-results.png' %}" width="150">
          <h3>No jobs match your criteria</h3>
          <p>Try adjusting filters.</p>
          <a href="{% url 'jobs:job_search' %}" class="clear-btn">Reset Search</a>
        </div>
      {% endif %}
    </section>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="{% static 'js/jobs/filter_drawer.js' %}"></script>

<script>
function updateQueryStringParameter(uri, key, value) {
  var re = new RegExp("([?&])" + key + "=.*?(&|$)", "i");
  var separator = uri.indexOf('?') !== -1 ? "&" : "?";
  if (uri.match(re)) {
    return uri.replace(re, '$1' + key + "=" + value + '$2');
  } else {
    return uri + separator + key + "=" + value;
  }
}

/* Drawer Logic */
document.addEventListener('DOMContentLoaded', function () {
  const toggleBtn = document.getElementById('filter-toggle-btn');
  const drawer = document.getElementById('filter-drawer');
  const closeBtn = document.getElementById('filter-close-btn');

  function openDrawer() {
    drawer.classList.add('open');
  }
  function closeDrawer() {
    drawer.classList.remove('open');
  }

  toggleBtn.addEventListener('click', openDrawer);
  closeBtn.addEventListener('click', closeDrawer);
});
</script>
{% endblock %}
